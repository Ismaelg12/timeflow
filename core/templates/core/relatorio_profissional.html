<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relatório - {{ profissional.nome }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-color: #4361ee;
            --secondary-color: #3f37c9;
            --success-color: #4cc9f0;
            --info-color: #4895ef;
            --warning-color: #f72585;
            --danger-color: #e63946;
            --light-bg: #f8f9fa;
            --card-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            --hover-shadow: 0 8px 25px rgba(0, 0, 0, 0.12);
            --plantao-12h-color: #ff9800;
            --plantao-24h-color: #4361ee;
        }
        
        body {
            background-color: #f5f7fb;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: #2d3748;
        }
        
        .container-fluid {
            max-width: 95%;
        }
        
        .card {
            border: none;
            border-radius: 12px;
            box-shadow: var(--card-shadow);
            transition: all 0.3s ease;
            overflow: hidden;
        }
        
        .card:hover {
            box-shadow: var(--hover-shadow);
            transform: translateY(-2px);
        }
        
        .card-header {
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            padding: 1.25rem 1.5rem;
            background: white;
        }
        
        .card-stat {
            border-radius: 12px;
            transition: transform 0.3s ease;
            border: none;
            overflow: hidden;
        }
        
        .card-stat:hover {
            transform: translateY(-5px);
        }
        
        .stat-icon {
            font-size: 2.5rem;
            opacity: 0.8;
        }
        
        .badge-horas {
            font-size: 0.75em;
            padding: 0.35em 0.65em;
        }
        
        .table-hover tbody tr:hover {
            background-color: rgba(67, 97, 238, 0.05);
        }
        
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }
        
        .btn {
            border-radius: 8px;
            font-weight: 500;
            padding: 0.5rem 1.25rem;
            transition: all 0.2s ease;
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        
        .btn-primary:hover {
            background-color: var(--secondary-color);
            border-color: var(--secondary-color);
            transform: translateY(-2px);
        }
        
        .form-control, .form-select {
            border-radius: 8px;
            padding: 0.75rem 1rem;
            border: 1px solid #e2e8f0;
            transition: all 0.2s ease;
        }
        
        .table th {
            border-top: none;
            font-weight: 600;
            color: #4a5568;
            background-color: #f7fafc;
            padding: 1rem 0.75rem;
        }
        
        .table td {
            padding: 1rem 0.75rem;
            border-top: 1px solid #edf2f7;
        }
        
        .list-group-item {
            border: none;
            padding: 1rem 1.25rem;
            border-bottom: 1px solid #edf2f7;
        }
        
        .page-title {
            font-weight: 700;
            color: #1a202c;
        }
        
        .bg-primary-custom {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)) !important;
        }
        
        .bg-info-custom {
            background: linear-gradient(135deg, var(--info-color), #3a86ff) !important;
        }
        
        .bg-success-custom {
            background: linear-gradient(135deg, var(--success-color), #4361ee) !important;
        }
        
        .bg-warning-custom {
            background: linear-gradient(135deg, var(--warning-color), #b5179e) !important;
        }
        
        .plantao-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .plantao-12h {
            background-color: rgba(255, 152, 0, 0.1);
            color: var(--plantao-12h-color);
            border: 1px solid var(--plantao-12h-color);
        }
        
        .plantao-24h {
            background-color: rgba(67, 97, 238, 0.1);
            color: var(--plantao-24h-color);
            border: 1px solid var(--plantao-24h-color);
        }
        
        .badge {
            border-radius: 6px;
            font-weight: 500;
            padding: 0.35em 0.65em;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 6px;
        }
        
        .status-delayed { background-color: #ffc107; }
        .status-early { background-color: #fd7e14; }
        
        .pagination .page-link {
            border-radius: 8px;
            margin: 0 2px;
            border: 1px solid #e2e8f0;
            color: var(--primary-color);
        }
        
        .pagination .page-link:hover {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
            color: white;
        }
        
        .pagination .page-item.active .page-link {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        
        .plantao-info-card {
            border-left: 4px solid var(--plantao-12h-color);
            background: linear-gradient(135deg, #fff8e1, #ffecb3);
        }
        
        .plantao-24h-info-card {
            border-left: 4px solid var(--plantao-24h-color);
            background: linear-gradient(135deg, #e8f4fd, #d0e7ff);
        }
        
        @media (max-width: 768px) {
            .container-fluid {
                max-width: 100%;
            }
            .btn {
                width: 100%;
                margin-bottom: 0.5rem;
            }
        }
        
        .registro-dia-card {
            border-left: 4px solid #4361ee;
            margin-bottom: 1rem;
            transition: all 0.2s ease;
        }
        
        .registro-dia-card.incompleto {
            border-left-color: var(--warning-color);
            background-color: rgba(247, 37, 133, 0.02);
        }
        
        .horas-dia-badge {
            font-size: 1.1rem;
            font-weight: 600;
        }
        
        .table-sm-inside {
            font-size: 0.9rem;
        }
        
        .table-sm-inside td {
            padding: 0.5rem;
        }
        
        .btn-registro-manual:hover {
            transform: scale(1.05);
        }
        
        .dias-restantes-badge {
            background-color: #e9ecef;
            color: #495057;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
        }
        
        .progress {
            height: 10px;
            border-radius: 5px;
            background-color: #e9ecef;
        }
        
        .progress-bar {
            border-radius: 5px;
        }
        /* Adicione no seu bloco de estilos */
.progresso-proporcional {
    width: 100%;
    height: 20px;
    background-color: #e9ecef;
    border-radius: 10px;
    border: 1px solid #dee2e6;
    position: relative;
    overflow: hidden;
    margin: 10px 0;
}

.progresso-preenchimento {
    height: 100%;
    border-radius: 10px;
    transition: width 0.5s ease;
    position: absolute;
    top: 0;
    left: 0;
}

.progresso-credito {
    background: linear-gradient(90deg, #28a745, #20c997);
}

.progresso-debito {
    background: linear-gradient(90deg, #ffc107, #fd7e14);
}

.progresso-texto {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: flex-end;
    padding-right: 10px;
    color: #495057;
    font-size: 12px;
    font-weight: bold;
    pointer-events: none;
}

.progresso-texto-branco {
    color: white;
    text-shadow: 0 1px 2px rgba(0,0,0,0.2);
}
    </style>
</head>
<body>
    <div class="container-fluid py-4">
        <!-- Cabeçalho -->
        <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-4">
            <div>
                <h1 class="page-title mb-1">
                    <i class="fas fa-chart-line me-2" style="color: var(--primary-color);"></i>
                    {% if request.user.is_superuser %}
                        Relatório de Pontos - {{ profissional.nome }} {{ profissional.sobrenome }}
                    {% else %}
                        Meu Relatório de Pontos
                    {% endif %}
                </h1>
                <div class="mt-2">
                    {% if is_plantao_24h %}
                    <span class="plantao-badge plantao-24h">
                        <i class="fas fa-hospital me-1"></i> Plantão 24 Horas
                    </span>
                    {% elif is_plantao_12h %}
                    <span class="plantao-badge plantao-12h">
                        <i class="fas fa-clock me-1"></i> Plantão 12 Horas
                    </span>
                    {% endif %}
                    <span class="dias-restantes-badge ms-2">
                        <i class="far fa-calendar-alt me-1"></i> {{ data_inicio|date:"d/m/Y" }} - {{ data_fim|date:"d/m/Y" }}
                    </span>
                </div>
            </div>
            <div class="d-flex gap-2 mt-3 mt-md-0">
                <a href="{% url 'core:relatorio_profissional_pdf' profissional.id %}?data_inicio={{ data_inicio_str }}&data_fim={{ data_fim_str }}" 
                   class="btn btn-danger" target="_blank">
                    <i class="fas fa-file-pdf me-2"></i> PDF
                </a>
                {% if request.user.is_superuser %}
                <a href="{% url 'core:dashboard' %}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-2"></i> Voltar
                </a>
                {% else %}
                <a href="{% url 'logout' %}" class="btn btn-outline-danger">
                    <i class="fas fa-sign-out-alt me-2"></i> Sair
                </a>
                {% endif %}
            </div>
        </div>

        <!-- Filtros - CORRIGIDO: SÓ FILTRA QUANDO CLICAR NO BOTÃO -->
        <div class="card mb-4">
            <div class="card-header bg-light">
                <h5 class="mb-0"><i class="fas fa-filter me-2 text-primary"></i> Filtros do Relatório</h5>
            </div>
            <div class="card-body">
                <form method="get" class="row g-3" id="filtro-form">
                    <div class="col-md-5">
                        <label class="form-label fw-semibold">Data Início</label>
                        <input type="date" class="form-control" name="data_inicio" value="{{ data_inicio_str }}">
                    </div>
                    <div class="col-md-5">
                        <label class="form-label fw-semibold">Data Fim</label>
                        <input type="date" class="form-control" name="data_fim" value="{{ data_fim_str }}">
                    </div>
                    <div class="col-md-2 d-flex align-items-end">
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="fas fa-search me-2"></i> Filtrar
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Informações do Profissional -->
        <div class="card mb-4">
            <div class="card-header" style="background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));">
                <h5 class="mb-0 text-white"><i class="fas fa-user me-2"></i> Informações do Profissional</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <p><strong><i class="fas fa-id-card me-2 text-primary"></i>Nome:</strong> {{ profissional.nome }} {{ profissional.sobrenome }}</p>
                        <p><strong><i class="fas fa-fingerprint me-2 text-primary"></i>CPF:</strong> {{ profissional.cpf }}</p>
                        <p><strong><i class="fas fa-briefcase me-2 text-primary"></i>Profissão:</strong> {{ profissional.profissao|default:"Não informado" }}</p>
                        {% if estabelecimento %}
                        <p><strong><i class="fas fa-building me-2 text-primary"></i>Estabelecimento:</strong> {{ estabelecimento.nome }}</p>
                        {% endif %}
                    </div>
                    <div class="col-md-6">
                        <p><strong><i class="fas fa-clock me-2 text-primary"></i>Carga Horária Diária:</strong> 
                            <span class="badge bg-primary ms-2">{{ carga_horaria_diaria }}</span>
                        </p>
                        <p><strong><i class="fas fa-calendar-week me-2 text-primary"></i>Carga Horária Semanal:</strong> 
                            <span class="badge bg-primary ms-2">{{ carga_horaria_semanal }}</span>
                        </p>
                        <p><strong><i class="fas fa-calculator me-2 text-primary"></i>Horas Esperadas no Período:</strong> 
                            <span class="badge bg-info ms-2">{{ banco_horas.horas_previstas }}</span>
                        </p>
                        {% if profissional.horario_entrada and profissional.horario_saida %}
                        <p><strong><i class="fas fa-business-time me-2 text-primary"></i>Horário de Trabalho:</strong> 
                            <span class="badge bg-info ms-2">{{ profissional.horario_entrada|time:"H:i" }} às {{ profissional.horario_saida|time:"H:i" }}</span>
                        </p>
                        {% endif %}
                        <p><strong><i class="fas fa-user-clock me-2 text-primary"></i>Tolerância:</strong> 
                            <span class="badge bg-warning text-dark ms-2">{{ tolerancia_minutos }} minutos</span>
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- BANCO DE HORAS - BARRA DE PROGRESSO PROPORCIONAL CORRIGIDA -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-light">
                <h5 class="mb-0"><i class="fas fa-balance-scale me-2 text-primary"></i> Banco de Horas</h5>
            </div>
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-4 text-center mb-3 mb-md-0">
                        <div class="display-4 fw-bold" style="color: {% if banco_horas.saldo_minutos >= 0 %}#28a745{% else %}#ffc107{% endif %};">
                            {{ banco_horas.saldo_formatado }}
                        </div>
                        <span class="badge bg-{% if banco_horas.saldo_minutos >= 0 %}success{% else %}warning{% endif %} bg-opacity-10 p-2 mt-2">
                            <i class="fas {% if banco_horas.saldo_minutos >= 0 %}fa-plus-circle{% else %}fa-minus-circle{% endif %} me-1"></i>
                            {{ banco_horas.status_texto }}
                        </span>
                    </div>
                    <div class="col-md-8">
                        <div class="row">
                            <div class="col-6 mb-2">
                                <small class="text-muted d-block">Horas Trabalhadas</small>
                                <strong class="fs-5">{{ banco_horas.horas_trabalhadas }}</strong>
                                <small class="text-muted ms-1">({{ banco_horas.horas_trabalhadas_decimal }}h)</small>
                            </div>
                            <div class="col-6 mb-2">
                                <small class="text-muted d-block">Horas Previstas</small>
                                <strong class="fs-5">{{ banco_horas.horas_previstas }}</strong>
                                <small class="text-muted ms-1">({{ banco_horas.horas_previstas_decimal }}h)</small>
                            </div>
                            <div class="col-12 mt-3">
                                <div class="d-flex justify-content-between mb-2">
                                    <span class="fw-semibold">Progresso do Período</span>
                                    <span class="badge bg-primary rounded-pill">{{ banco_horas.percentual_concluido }}%</span>
                                </div>
                                
                                <!-- ### BARRA DE PROGRESSO PROPORCIONAL - CORRIGIDA ### -->
                                <div style="width: 100%; height: 20px; background-color: #e9ecef; border-radius: 10px; margin: 10px 0; border: 1px solid #dee2e6; position: relative; overflow: hidden;">
                                    <div style="width: {{ banco_horas.percentual_concluido }}%; 
                                                height: 100%; 
                                                background: {% if banco_horas.saldo_minutos >= 0 %}linear-gradient(90deg, #28a745, #20c997){% else %}linear-gradient(90deg, #ffc107, #fd7e14){% endif %};
                                                border-radius: 10px;
                                                transition: width 0.5s ease;
                                                position: absolute;
                                                top: 0;
                                                left: 0;">
                                    </div>
                                    <!-- Indicador visual da porcentagem -->
                                    <div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: flex-end; padding-right: 10px; color: #495057; font-size: 12px; font-weight: bold; pointer-events: none;">
                                        {% if banco_horas.percentual_concluido < 15 %}
                                            {{ banco_horas.percentual_concluido }}%
                                        {% endif %}
                                    </div>
                                </div>
                                <!-- ### FIM DA BARRA PROPORCIONAL ### -->
                                
                                <!-- Barra de referência visual (opcional) -->
                                <div style="display: flex; justify-content: space-between; margin-top: 5px; font-size: 10px; color: #6c757d;">
                                    <span>0%</span>
                                    <span>25%</span>
                                    <span>50%</span>
                                    <span>75%</span>
                                    <span>100%</span>
                                </div>
                                
                                <div class="d-flex justify-content-between mt-3">
                                    <div>
                                        <i class="fas fa-clock me-1" style="color: {% if banco_horas.saldo_minutos >= 0 %}#28a745{% else %}#ffc107{% endif %};"></i>
                                        <span class="fw-bold {% if banco_horas.saldo_minutos >= 0 %}text-success{% else %}text-warning{% endif %}">
                                            Saldo: {{ banco_horas.saldo_formatado }}
                                        </span>
                                    </div>
                                    <div>
                                        <i class="fas fa-calendar-alt me-1 text-muted"></i>
                                        <span class="text-muted">
                                            {{ dias_trabalhados }} de {{ dias_uteis }} dias
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

        <!-- Estatísticas de Atrasos -->
        {% if total_atrasos > 0 or total_saidas_antecipadas > 0 %}
        <div class="row mb-4">
            <div class="col-12">
                <div class="card border-warning">
                    <div class="card-header bg-warning bg-opacity-10 border-warning">
                        <h5 class="mb-0 text-warning"><i class="fas fa-exclamation-triangle me-2"></i> Controle de Tolerância</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <p><span class="status-dot status-delayed"></span> <strong>Atrasos:</strong> 
                                    <span class="badge bg-warning text-dark">{{ total_atrasos }} min</span>
                                    <small class="text-muted ms-2">({{ registros_com_atraso }} registros, média {{ media_atrasos }} min)</small>
                                </p>
                            </div>
                            <div class="col-md-6">
                                <p><span class="status-dot status-early"></span> <strong>Saídas Antecipadas:</strong> 
                                    <span class="badge bg-warning text-dark">{{ total_saidas_antecipadas }} min</span>
                                    <small class="text-muted ms-2">({{ registros_com_saida_antecipada }} registros, média {{ media_saidas_antecipadas }} min)</small>
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Cards de Estatísticas -->
        <div class="row mb-4">
            <div class="col-xl-3 col-md-6 mb-3">
                <div class="card text-white bg-primary-custom card-stat h-100">
                    <div class="card-body">
                        <h6 class="card-title opacity-75">Total de Horas</h6>
                        <h2 class="card-text fw-bold">{{ horas_trabalhadas }}</h2>
                        <small>{{ horas_trabalhadas_decimal }} horas</small>
                        {% if diferenca_horas_decimal != 0 %}
                        <div class="mt-2">
                            <span class="badge bg-light text-dark">
                                {% if diferenca_horas_decimal > 0 %}+{% endif %}{{ diferenca_horas_decimal }}h
                            </span>
                            <small class="opacity-75"> vs esperado</small>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            <div class="col-xl-3 col-md-6 mb-3">
                <div class="card text-white bg-info-custom card-stat h-100">
                    <div class="card-body">
                        <h6 class="card-title opacity-75">Média Diária</h6>
                        <h2 class="card-text fw-bold">{{ horas_trabalhadas_decimal|floatformat:1 }}h</h2>
                        <small>por dia trabalhado</small>
                    </div>
                </div>
            </div>
            <div class="col-xl-3 col-md-6 mb-3">
                <div class="card text-white bg-success-custom card-stat h-100">
                    <div class="card-body">
                        <h6 class="card-title opacity-75">Registros</h6>
                        <h2 class="card-text fw-bold">{{ total_registros }}</h2>
                        <small>{{ entradas }} entradas / {{ saidas }} saídas</small>
                    </div>
                </div>
            </div>
            <div class="col-xl-3 col-md-6 mb-3">
                <div class="card text-white bg-warning-custom card-stat h-100">
                    <div class="card-body">
                        <h6 class="card-title opacity-75">Dias Trabalhados</h6>
                        <h2 class="card-text fw-bold">{{ dias_trabalhados }}</h2>
                        <small>de {{ dias_uteis }} dias</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Informação Plantão -->
        {% if is_plantao_24h or is_plantao_12h %}
        <div class="row mb-4">
            <div class="col-12">
                <div class="card {% if is_plantao_24h %}plantao-24h-info-card{% else %}plantao-info-card{% endif %}">
                    <div class="card-body">
                        <div class="d-flex">
                            <i class="fas {% if is_plantao_24h %}fa-hospital{% else %}fa-clock{% endif %} me-3" style="font-size: 1.5rem;"></i>
                            <div>
                                <h5>{% if is_plantao_24h %}Plantão 24 Horas{% else %}Plantão 12 Horas{% endif %}</h5>
                                <p class="mb-0 small">
                                    {% if is_plantao_24h %}
                                        Entrada e saída em dias diferentes. 24h × todos os dias do período.
                                    {% else %}
                                        Baseado em dias úteis. 12h × dias úteis.
                                    {% endif %}
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Gráfico e Resumo por Dia da Semana -->
        <div class="row mb-4">
            <div class="col-lg-8 mb-4 mb-lg-0">
                <div class="card h-100">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-chart-bar me-2 text-primary"></i> Horas por Dia da Semana</h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="horasDiaSemanaChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-4">
                <div class="card h-100">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-table me-2 text-primary"></i> Resumo por Dia</h5>
                    </div>
                    <div class="card-body p-0">
                        <div class="list-group list-group-flush">
                            {% for dia in horas_por_dia %}
                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                <span>{{ dia.dia }}</span>
                                <div>
                                    <span class="badge bg-primary rounded-pill me-2">{{ dia.horas }}</span>
                                    <small class="text-muted">{{ dia.media }}h/dia</small>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- DIAS INCOMPLETOS - DESTAQUE -->
        {% if dias_incompletos and request.user.is_superuser %}
        <div class="row mb-4">
            <div class="col-12">
                <div class="card border-warning">
                    <div class="card-header bg-warning bg-opacity-10">
                        <h5 class="mb-0 text-warning"><i class="fas fa-exclamation-triangle me-2"></i> Dias com Registro Incompleto</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            {% for grupo in registros_agrupados %}
                                {% if grupo.incompleto %}
                                <div class="col-md-6 col-lg-4 mb-3">
                                    <div class="d-flex justify-content-between align-items-center p-3 bg-light rounded">
                                        <div>
                                            <strong>{{ grupo.data|date:"d/m/Y" }}</strong>
                                            <small class="text-muted d-block">{{ grupo.data|date:"l" }}</small>
                                            <small>Entrada: 
                                                {% for r in grupo.registros %}
                                                    {% if r.tipo == 'ENTRADA' %}{{ r.horario|time:"H:i" }}{% endif %}
                                                {% endfor %}
                                            </small>
                                        </div>
                                        <button class="btn btn-sm btn-warning" onclick="abrirModalRegistroManual('{{ grupo.data|date:'Y-m-d' }}')">
                                            <i class="fas fa-pen me-1"></i> Registrar Saída
                                        </button>
                                    </div>
                                </div>
                                {% endif %}
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- REGISTROS AGRUPADOS POR DIA -->
        {% if registros_agrupados %}
        <div class="card mb-4">
            <div class="card-header bg-light d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-calendar-day me-2 text-primary"></i> Registros por Dia</h5>
                <button class="btn btn-sm btn-outline-primary" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTodosDias">
                    <i class="fas fa-eye me-1"></i> Ver todos os dias
                </button>
            </div>
            <div class="card-body">
                <!-- ÚLTIMOS 5 DIAS -->
                <h6 class="fw-bold mb-3"><i class="fas fa-clock me-2 text-primary"></i> Últimos 5 dias</h6>
                {% for grupo in registros_agrupados|slice:":5" %}
                    {% include "core/includes/registro_dia_card.html" with grupo=grupo %}
                {% endfor %}
                
                <!-- DIAS ANTERIORES -->
                {% if registros_agrupados|length > 5 %}
                <div class="collapse mt-3" id="collapseTodosDias">
                    <h6 class="fw-bold mb-3"><i class="fas fa-history me-2 text-primary"></i> Dias anteriores</h6>
                    {% for grupo in registros_agrupados|slice:"5:" %}
                        {% include "core/includes/registro_dia_card.html" with grupo=grupo %}
                    {% endfor %}
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}

        <!-- TODOS OS REGISTROS (TABELA PAGINADA) -->
        <div class="card">
            <div class="card-header bg-light d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-list-ol me-2 text-primary"></i> Todos os Registros</h5>
                <span class="badge bg-secondary">{{ total_registros }} registros</span>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th>Data</th>
                                <th>Horário</th>
                                <th>Tipo</th>
                                <th>Status</th>
                                <th>Estabelecimento</th>
                                {% if request.user.is_superuser %}
                                <th>Observações</th>
                                {% endif %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for registro in page_obj %}
                            <tr>
                                <td>{{ registro.data|date:"d/m/Y" }}</td>
                                <td>{{ registro.horario|time:"H:i" }}</td>
                                <td>
                                    <span class="badge {% if registro.tipo == 'ENTRADA' %}bg-success{% else %}bg-danger{% endif %}">
                                        {{ registro.get_tipo_display }}
                                    </span>
                                </td>
                                <td>
                                    {% if registro.atraso_minutos > 0 %}
                                        <span class="badge bg-warning text-dark">Atraso: {{ registro.atraso_minutos }}min</span>
                                    {% elif registro.saida_antecipada_minutos > 0 %}
                                        <span class="badge bg-warning text-dark">Antec: {{ registro.saida_antecipada_minutos }}min</span>
                                    {% else %}
                                        <span class="badge bg-success">OK</span>
                                    {% endif %}
                                </td>
                                <td>{{ registro.estabelecimento.nome|truncatechars:30 }}</td>
                                {% if request.user.is_superuser %}
                                <td>
                                    {% if registro.ajuste_manual %}
                                        <span class="badge bg-info">Manual</span>
                                    {% endif %}
                                    <small class="text-muted">{{ registro.observacoes|truncatechars:30|default:"-" }}</small>
                                </td>
                                {% endif %}
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="{% if request.user.is_superuser %}6{% else %}5{% endif %}" class="text-center py-5">
                                    <i class="fas fa-inbox fa-3x mb-3 opacity-50"></i><br>
                                    Nenhum registro encontrado
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <!-- Paginação -->
                {% if page_obj.paginator.num_pages > 1 %}
                <div class="card-footer">
                    <nav>
                        <ul class="pagination justify-content-center mb-0">
                            {% if page_obj.has_previous %}
                            <li class="page-item">
                                <a class="page-link" href="?data_inicio={{ data_inicio_str }}&data_fim={{ data_fim_str }}&page=1">
                                    <i class="fas fa-angle-double-left"></i>
                                </a>
                            </li>
                            <li class="page-item">
                                <a class="page-link" href="?data_inicio={{ data_inicio_str }}&data_fim={{ data_fim_str }}&page={{ page_obj.previous_page_number }}">
                                    <i class="fas fa-angle-left"></i>
                                </a>
                            </li>
                            {% endif %}

                            {% for num in page_obj.paginator.page_range %}
                                {% if num == page_obj.number %}
                                <li class="page-item active"><span class="page-link">{{ num }}</span></li>
                                {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                                <li class="page-item">
                                    <a class="page-link" href="?data_inicio={{ data_inicio_str }}&data_fim={{ data_fim_str }}&page={{ num }}">{{ num }}</a>
                                </li>
                                {% endif %}
                            {% endfor %}

                            {% if page_obj.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="?data_inicio={{ data_inicio_str }}&data_fim={{ data_fim_str }}&page={{ page_obj.next_page_number }}">
                                    <i class="fas fa-angle-right"></i>
                                </a>
                            </li>
                            <li class="page-item">
                                <a class="page-link" href="?data_inicio={{ data_inicio_str }}&data_fim={{ data_fim_str }}&page={{ page_obj.paginator.num_pages }}">
                                    <i class="fas fa-angle-double-right"></i>
                                </a>
                            </li>
                            {% endif %}
                        </ul>
                    </nav>
                    <div class="text-center mt-2 text-muted small">
                        Página {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- MODAL PARA REGISTRO MANUAL -->
    {% if request.user.is_superuser %}
    <div class="modal fade" id="modalRegistroManual" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-warning">
                    <h5 class="modal-title text-dark">
                        <i class="fas fa-pen-fancy me-2"></i> Registro Manual de Ponto
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form method="post" action="{% url 'registro_manual_saida' %}" id="formRegistroManual">
                    {% csrf_token %}
                    <input type="hidden" name="profissional_id" value="{{ profissional.id }}">
                    <input type="hidden" name="data" id="manual_data">
                    <input type="hidden" name="horario" id="horario">
                    
                    <div class="modal-body">
                        <div class="text-center mb-4">
                            <span class="badge bg-warning text-dark p-3" style="font-size: 1.1rem;">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                REGISTRO INCOMPLETO DETECTADO
                            </span>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">Profissional</label>
                                <div class="form-control bg-light" readonly>
                                    <i class="fas fa-user me-2 text-primary"></i> {{ profissional.nome }} {{ profissional.sobrenome }}
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">Data do registro</label>
                                <div class="form-control bg-light" readonly id="manual_data_display"></div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">
                                    <i class="fas fa-clock me-2 text-primary"></i>Horário da saída
                                </label>
                                <input type="time" class="form-control" id="horario_input" name="horario" value="18:00">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">
                                    <i class="fas fa-gavel me-2 text-primary"></i>Justificativa
                                </label>
                                <select class="form-select" id="justificativa" name="justificativa">
                                    <option value="">Selecione...</option>
                                    {% for codigo, descricao in justificativas %}
                                    <option value="{{ codigo }}">{{ descricao }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label fw-bold">
                                <i class="fas fa-comment me-2 text-primary"></i>Observações
                            </label>
                            <textarea class="form-control" name="observacoes" rows="2" placeholder="Informações complementares..."></textarea>
                        </div>
                        
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Este registro será marcado como:</strong>
                            <span class="badge bg-warning text-dark ms-2">MANUAL</span>
                            <span class="badge bg-danger ms-2">RETROATIVO</span>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="fas fa-times me-2"></i> Cancelar
                        </button>
                        <button type="button" class="btn btn-warning" onclick="alert('Funcionalidade em desenvolvimento. Layout apenas para visualização.');">
                            <i class="fas fa-save me-2"></i> Registrar Saída Manual
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        function abrirModalRegistroManual(data) {
            // Formatar data
            const partes = data.split('-');
            const dataFormatada = `${partes[2]}/${partes[1]}/${partes[0]}`;
            
            // Preencher campos
            document.getElementById('manual_data').value = data;
            document.getElementById('manual_data_display').innerHTML = 
                `<strong>${dataFormatada}</strong>`;
            
            // Abrir modal
            new bootstrap.Modal(document.getElementById('modalRegistroManual')).show();
        }
    </script>
    {% endif %}

    <script>
        // Gráfico de horas
        {% if horas_por_dia %}
        const ctx = document.getElementById('horasDiaSemanaChart').getContext('2d');
        const dias = [{% for dia in horas_por_dia %}"{{ dia.dia }}",{% endfor %}];
        const valores = [{% for dia in horas_por_dia %}{{ dia.horas_decimal|floatformat:2 }},{% endfor %}];
        
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: dias,
                datasets: [{
                    label: 'Horas Trabalhadas',
                    data: valores,
                    backgroundColor: 'rgba(67, 97, 238, 0.7)',
                    borderColor: '#4361ee',
                    borderWidth: 2,
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: { display: true, text: 'Horas' }
                    }
                }
            }
        });
        {% endif %}
    </script>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>